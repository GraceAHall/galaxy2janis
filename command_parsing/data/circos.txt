## Directory structure
mkdir -p circos/conf/ circos/data/ &&

#if $reference_genome.ref.ref_source == 'history':
    ln -s '$reference_genome.ref.genome_fasta' genomeref.fa &&
#end if

#if $reference_genome.ref.ref_source in ('lengths', 'cached'):
    python '$__tool_directory__/karyotype-from-lengths.py'
        #if $reference_genome.ref.ref_source == 'lengths'
            '${reference_genome.ref.input_lengths}'
        #else
            #if $ideogram.limit_chromosomes:
                ## If they are limiting the chromosomes, ensure they have access to the full list
                '${reference_genome.ref.fasta_indexes.fields.len_path}'
            #else
                ## Otherwise only the reduced list, as the full list will often overwhelm circos
                <(head -n 50 '${reference_genome.ref.fasta_indexes.fields.len_path}')
            #end if
        #end if
        > circos/conf/karyotype.txt &&
#else if $reference_genome.ref.ref_source == 'karyotype':
    cp $reference_genome.ref.input_karyotype circos/conf/karyotype.txt &&
#else if str($reference_genome.ref.ref_source) == 'history':
    ## Process the karyotype.txt file
    python
        '$__tool_directory__/karyotype-from-fasta.py'
        genomeref.fa
        > circos/conf/karyotype.txt &&
#else if $reference_genome.ref.ref_source == 'preset':
    cp '$__tool_directory__/karyotype/'${reference_genome.ref.preset_karyotype} circos/conf/karyotype.txt &&
#end if

python '$__tool_directory__/karyotype-colors.py' `grep -c '^chr\s' 'circos/conf/karyotype.txt'`
    > 'circos/conf/karyotype-colors.conf' &&

touch circos/conf/karyotype-colors.conf &&

## #if $ideogram.bands.bands:
##     #if $ideogram.bands.convert_bands:
##         python '$__tool_directory__/process-cytogenetic-bands.py'
##             '${ideogram.bands.bands}'
##             >> circos/conf/karyotype.txt
##             2> circos/conf/karyotype-colors.conf &&
##     #else
##         cat '${ideogram.bands.bands}'
##             >> circos/conf/karyotype.txt &&
##     #end if
## #end if

#if $plot_options.colour_profile:
    #if str($plot_options.colour_profile) == 'cg':
        cat '$__tool_directory__/colours/cg.conf' >> circos/conf/karyotype-colors.conf &&
    #end if
#end if

cp '$circos_conf' circos/conf/circos.conf &&
cp '$ticks_conf' circos/conf/ticks.conf &&
cp '$ideogram_conf' circos/conf/ideogram.conf &&
cp '$data_conf'  circos/conf/data.conf &&
cp '$links_conf'  circos/conf/links.conf &&
cp '$test_case_conf' circos/conf/galaxy_test_case.json &&

## 2D Data Plots
#for $hi, $data in enumerate($sec_tdd.data):
    cp '${data.plot_format.data_source}' circos/data/data-${hi}.txt &&
#end for

## Link Tracks
#for $hi, $data in enumerate($sec_links.data):
    cp '${data.data_source}' circos/data/links-${hi}.txt &&
#end for

#if $outputs.tar == "yes"
    tar -czf circos.tar.gz circos &&
#end if

#if $outputs.svg == "yes" or $outputs.png == "yes":
    circos -conf circos/conf/circos.conf -noparanoid
#end if